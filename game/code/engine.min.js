var map_overlay,walls,animations,start,canvas_id="game",tile_rows=9,tile_columns=13,tile_size=80,animation_speed=50,tile_path="resources/tiles/",char_path="resources/anims/",chars_amount=13,tiles_amount=21,update_speed=1,player_speed=2,show_load_time=!1,show_custom_error=!0,show_fps=!0,cnv=document.getElementById("game"),fps=document.getElementById("fps"),ctx=cnv.getContext("2d",{antialias:!0}),map=[],anims=[],tiles=[],key_map={},frame=0,map_frame=0,map_overlay_frame=0,char_offset=tile_size/2;function map_start(){start=new Date,maps_setup(),setup(),ctx.canvas.width=tile_columns*tile_size,ctx.canvas.height=tile_rows*tile_size;for(var t=0;t<tiles_amount;t++)tiles[t]=new Image,tiles[t].src=tile_path+(t+1)+".png";for(t=0;t<animations.length;t++){anims[t]=new animation,anims[t].setup(animations[t][0],animations[t][1]);for(var a=0;a<animations[t].length-2;a++)anims[t].frame_pattern[a]=animations[t][a+2]}}function map_update(){for(x=0;x<tile_columns;x++)for(y=0;y<tile_rows;y++)tile_set(x,y);for(var t=0;t<animations.length;t++)anims[t].display();update(),show_fps&&frame%10==0&&(fps.innerHTML="FPS: "+Math.floor(frame/(millis()/1e3)))}function tile_set(t,a){tile_nr=map[map_frame][a][t],tile_nr>0&&tile_nr<tiles_amount+1&&ctx.drawImage(tiles[tile_nr-1],t*tile_size,a*tile_size),tile_nr=map_overlay[map_overlay_frame][a][t],tile_nr>0&&tile_nr<tiles_amount+1&&ctx.drawImage(tiles[tile_nr-1],t*tile_size,a*tile_size)}function map_template(){this.map=[],this.map_overlay=[],this.walls=[],this.load_map=function(){map=this.map,map_overlay=this.map_overlay,map_animations=this.map_animations,walls=this.walls}}function char(){this.idle_frame=0,this.walk_frame=0,this.frames_idle=[],this.frames_walk=[],this.walk_path=[],this.imgs=[],this.last_walk,this.firstrun=!0,this.setup=function(t,a){this.x=t,this.y=a;for(var e=0;e<chars_amount;e++)this.imgs[e]=new Image,this.imgs[e].src=char_path+(e+1)+".png"},this.animate=function(){this.idle_frame++,this.walk_frame++,this.idle_frame>this.frames_idle.length-1&&(this.idle_frame=0),this.walk_frame>this.frames_walk.length-1&&(this.walk_frame=0),this.steer=!1},this.display=function(){millis()-this.last_walk<300?ctx.drawImage(this.imgs[this.frames_walk[this.walk_frame]-1],this.x-char_offset,this.y-char_offset):ctx.drawImage(this.imgs[this.frames_idle[this.idle_frame]-1],this.x-char_offset,this.y-char_offset)},this.move=function(t,a,e){this.steer=!0,e?(this.x=parseInt(t),this.y=parseInt(a)):(this.x=parseInt(this.x+t),this.y=parseInt(this.y+a)),this.last_walk=millis()},this.move_collider=function(t,a){temp_pos_x=Math.floor((this.x+t)/tile_size),temp_pos_y=Math.floor((this.y+a)/tile_size),1!=walls[temp_pos_y][temp_pos_x]&&this.move(t,a,!1),wall_event(walls[temp_pos_y][temp_pos_x])},this.animate_move=function(t,a){if(this.firstrun&&(this.firstrun=!1,k=(a-this.y)/(t-this.x)),this.x==t||this.y==a)return this.firstrun=!0,!0;this.move(player_speed/2,k*player_speed/2)}}function animation(){this.frame=0,this.frames=[],this.frame_pattern=[],this.setup=function(t,a){this.x=t,this.y=a;for(var e=0;e<chars_amount;e++)this.frames[e]=new Image,this.frames[e].src=char_path+(e+1)+".png"},this.animate=function(){this.frame++,this.frame>this.frame_pattern.length-1&&(this.frame=0)},this.display=function(){ctx.drawImage(this.frames[this.frame_pattern[this.frame]-1],this.x,this.y)}}function millis(){return new Date-start}onkeypress=function(){onkeydown=function(t){key_map[t.keyCode]=!0},onkeyup=function(t){key_map[t.keyCode]=!1}},map_start(),window.onload=map_update,show_load_time&&console.log("Loading-time:",millis(),"ms"),setInterval(function(){if(frame++,map_update(),frame%animation_speed==0)for(var t=0;t<animations.length;t++)map_overlay_frame++,++map_frame>=map.length&&(map_frame=0),map_overlay_frame>=map_overlay.length&&(map_overlay_frame=0),animate_update(),anims[t].animate()},update_speed);